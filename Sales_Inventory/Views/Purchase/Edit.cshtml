@model Sales_Inventory.Models.PurchaseViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>Purchase Edit</h1>
    <ol class="breadcrumb">
        <li><a href="@Url.Action("Index", "Home")"><i class="fa fa-dashboard"></i> Dashboard</a></li>
        <li><a href="@Url.Action("List", "Purchase")"><i class="fa fa-calendar"></i> Purchase List</a></li>
        <li class="active">Edit</li>
    </ol>
</section>

<div class="col-md-12">
    <div class="box box-primary">
        <div class="box-header with-border">
            <h3 class="box-title">Profile Detail</h3>
        </div>
        @Html.HiddenFor(m => m.Id, new { id = "purchaseId" })
        <div class="box-body">
            <div class="col-md-3 col-sm-6">
                <div class="form-group">
                    <label>Purchase From</label>
                    @Html.TextBoxFor(m => m.Purchase_From, new { @class = "form-control required", placeholder = "Enter Purchase From Name", @id = "purchaseFrom" })
                    @Html.ValidationMessageFor(m => m.Purchase_From)
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="form-group">
                    <label>Seller Phone </label>
                    @Html.TextBoxFor(m => m.Purchase_From_Phone, new { @class = "form-control required", placeholder = "Enter Seller Phone No", @id = "sellerPhoneNo" })
                    @Html.ValidationMessageFor(m => m.Purchase_From_Phone)
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="form-group">
                    <label>Purchase Date</label>
                    <div class="input-group">
                        <div class="input-group-addon">
                            <i class="fa fa-calendar"></i>
                        </div>
                        @Html.TextBoxFor(m => m.Purchase_Date, "{0:dd/MM/yyyy}", new { @class = "form-control", placeholder = "Enter Purchase Date dd/mm/yyyy", @id = "purchaseDate" })
                        @Html.ValidationMessageFor(m => m.Purchase_Date)
                    </div>
                </div>
            </div>
            <table id="tblProducts" class="table" cellpadding="0" cellspacing="0">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Quantity(Kgs)</th>
                        <th>Price(Per KG)</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.purchase_Products)
                    {
                        <tr>
                            <td>@Html.TextBoxFor(m => item.ItemName, new { @class = "form-control", @id = "txtItemName" })</td>
                            <td>@Html.TextBoxFor(m => item.Quantity, new { @class = "form-control", @id = "txtQuantity" })</td>
                            <td>@Html.TextBoxFor(m => item.Price, new { @class = "form-control", @id = "txtPrice" })</td>
                            <td>@Html.TextBoxFor(m => item.Total, new { @class = "form-control", @id = "txtTotal", @readonly = "true" })</td>
                            <td><input type="button" value="Remove" onclick="Remove(this)" class="form-control" /></td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td>@Html.DropDownList("MyProducts", new SelectList(Model.ProductList, "Text", "Text"), new { @class = "form-control required", @id = "txtItemName", type = "option" })</td>
                        <td><input type="number" id="txtQuantityNew" class="form-control" /></td>
                        <td><input type="text" id="txtPriceNew" class="form-control" /></td>
                        <td><input type="text" id="txtTotal" class="form-control" readonly /></td>
                        <td><input type="button" id="btnAdd" value="Add" class="form-control" /></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="box-footer">
            <input type="submit" class="btn btn-primary" value="Update" id="btnSave" />
            <a href="@Url.Action("List", "Purchase")" class="btn btn-default">Cancel</a>
        </div>
    </div>
</div>

<script type="text/javascript">
    $("body").on("click", "#btnAdd", function () {
        //Reference the Name and Country TextBoxes.
        var txtItemName = $("#txtItemName");
        var txtQuantity = $("#txtQuantity");
        var txtPrice = $("#txtPrice");
        var txtTotal = $("#txtTotal");

        //Get the reference of the Table's TBODY element.
        var tBody = $("#tblProducts > TBODY")[0];

        //Add Row.
        var row = tBody.insertRow(-1);

        //Add Name cell.
        var cell = $(row.insertCell(-1));
        cell.html(txtItemName.val());

        //Add Quantity cell.
        cell = $(row.insertCell(-1));
        cell.html(txtQuantity.val());

        //Add Price cell.
        cell = $(row.insertCell(-1));
        cell.html(txtPrice.val());

        //Add Total cell.
        cell = $(row.insertCell(-1));
        cell.html(txtTotal.val());

        //Add Button cell.
        cell = $(row.insertCell(-1));
        var btnRemove = $("<input />");
        btnRemove.attr("type", "button");
        btnRemove.attr("class", "form-control");
        btnRemove.attr("onclick", "Remove(this);");
        btnRemove.val("Remove");
        cell.append(btnRemove);

        //Clear the TextBoxes.
        txtItemName.val("");
        txtQuantity.val("");
        txtPrice.val("");
        txtTotal.val("");
    });

    function Remove(button) {
        //Determine the reference of the Row using the Button.
        var row = $(button).closest("TR");
        var name = $("TD", row).eq(0).html();
        if (confirm("Do you want to delete this product")) {
            //Get the reference of the Table.
            var table = $("#tblProducts")[0];

            //Delete the Table row using it's Index.
            table.deleteRow(row[0].rowIndex);
        }
    };

    $("body").on("click", "#btnSave", function () {
        //Loop through the Table rows and build a JSON array.
        var purchase_Products = new Array();
        $("#tblProducts TBODY TR").each(function () {
            var row = $(this);
            var product = {};
            product.ItemName = row.find("TD").eq(0).html();
            product.Quantity = row.find("TD").eq(1).html();
            product.Price = row.find("TD").eq(2).html();
            product.Total = row.find("TD").eq(3).html();
            purchase_Products.push(product);
        });

        var data = new FormData();
        data.append('purchaseId', $("#purchaseId").val());
        data.append('purchaseFrom', $("#purchaseFrom").val());
        data.append('purchaseBy', $("#purchaseBy").val());
        data.append('sellerPhoneNo', $("#sellerPhoneNo").val());
        data.append('buyerPhoneNo', $("#buyerPhoneNo").val());
        data.append('purchaseDate', $("#purchaseDate").val());
        data.append('purchase_Prod', JSON.stringify(purchase_Products));
        debugger;

        //Send the JSON array to Controller using AJAX.
        $.ajax({
            type: "POST",
            url: "/Purchase/Edit",
            data: data,
            processData: false,
            contentType: false,
            success: function (r) {
                alert("Record(s) Updated.");
                window.location.href("/Purchase/List");
            }
        });
    });
</script>

<script>
    $('#txtPrice').keyup(function () {
        var textone;
        var texttwo;
        textone = parseFloat($('#txtQuantity').val());
        texttwo = parseFloat($('#txtPrice').val());
        var result = textone * texttwo;
        $('#txtTotal').val(result.toFixed(2));
    });

    $('#txtPrice1').keyup(function () {
        var textone;
        var texttwo;
        textone = parseFloat($('#txtQuantity1').val());
        texttwo = parseFloat($('#txtPrice1').val());
        var result = textone * texttwo;
        $('#txtTotal1').val(result.toFixed(2));
    });
</script>
