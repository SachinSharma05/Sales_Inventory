@model Sales_Inventory.Models.PurchaseViewModel

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<form method="post" enctype="multipart/form-data" id="purchaseForm">
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Profile Detail</h3>
            </div>
            <div class="box-body">
                <div class="col-md-3 col-sm-6">
                    <div class="form-group">
                        <label>Purchase From</label>
                        @Html.TextBoxFor(m => m.Purchase_From, new { @class = "form-control required", placeholder = "Enter Purchase From Name", @id = "purchaseFrom" })
                        @Html.ValidationMessageFor(m => m.Purchase_From)
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="form-group">
                        <label>Buyer Name</label>
                        @Html.TextBoxFor(m => m.Purchase_By, new { @class = "form-control required", placeholder = "Enter Buyer Name", @id = "purchaseBy" })
                        @Html.ValidationMessageFor(m => m.Purchase_By)
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="form-group">
                        <label>Seller Phone </label>
                        @Html.TextBoxFor(m => m.Purchase_From_Phone, new { @class = "form-control required", placeholder = "Enter Purchase From Phone", @id = "sellerPhoneNo" })
                        @Html.ValidationMessageFor(m => m.Purchase_From_Phone)
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <div class="input-group">
                            <div class="input-group-addon">
                                <i class="fa fa-calendar"></i>
                            </div>
                            @Html.TextBoxFor(m => m.Purchase_Date, "{0:dd/MM/yyyy}", new { @class = "form-control", placeholder = "Enter Purchase Date dd/mm/yyyy", @id = "purchaseDate" })
                            @Html.ValidationMessageFor(m => m.Purchase_Date)
                        </div>
                    </div>
                </div>

                <h5>Product Details</h5>
                <table id="tblProducts" class="table" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity(Kgs)</th>
                            <th>Price(Per KG)</th>
                            <th>Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.purchase_Products)
                        {
                            <tr>
                                <td>@item.Item</td>
                                <td>@item.Quantity</td>
                                <td>@item.Price</td>
                                <td>@item.Total</td>
                                <td><input type="button" value="Remove" onclick="Remove(this)" /></td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><input type="text" id="txtItemName" /></td>
                            <td><input type="number" id="txtQuantity" /></td>
                            <td><input type="text" id="txtPrice" /></td>
                            <td><input type="text" id="txtTotal" /></td>
                            <td><input type="button" id="btnAdd" value="Add" /></td>
                        </tr>
                    </tfoot>
                </table>

            </div>
            <div class="box-footer">
                <input type="submit" class="btn btn-primary" value="Submit" id="btnSave" />
                <a href="@Url.Action("List", "Purchase")" class="btn btn-default">Cancel</a>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">
    $("body").on("click", "#btnAdd", function () {
        //Reference the Name and Country TextBoxes.
        var txtItemName = $("#txtItemName");
        var txtQuantity = $("#txtQuantity");
        var txtPrice = $("#txtPrice");
        var txtTotal = $("#txtTotal");

        //Get the reference of the Table's TBODY element.
        var tBody = $("#tblProducts > TBODY")[0];

        //Add Row.
        var row = tBody.insertRow(-1);

        //Add Name cell.
        var cell = $(row.insertCell(-1));
        cell.html(txtItemName.val());

        //Add Age cell.
        cell = $(row.insertCell(-1));
        cell.html(txtQuantity.val());

        //Add Sex cell.
        cell = $(row.insertCell(-1));
        cell.html(txtPrice.val());

        //Add Berth cell.
        cell = $(row.insertCell(-1));
        cell.html(txtTotal.val());

        //Add Button cell.
        cell = $(row.insertCell(-1));
        var btnRemove = $("<input />");
        btnRemove.attr("type", "button");
        btnRemove.attr("onclick", "Remove(this);");
        btnRemove.val("Remove");
        cell.append(btnRemove);

        //Clear the TextBoxes.
        txtItemName.val("");
        txtQuantity.val("");
        txtPrice.val("");
        txtTotal.val("");
    });

    function Remove(button) {
        //Determine the reference of the Row using the Button.
        var row = $(button).closest("TR");
        var name = $("TD", row).eq(0).html();
        if (confirm("Do you want to delete: " + name)) {
            //Get the reference of the Table.
            var table = $("#tblProducts")[0];

            //Delete the Table row using it's Index.
            table.deleteRow(row[0].rowIndex);
        }
    };

    $("body").on("click", "#btnSave", function () {
        //Loop through the Table rows and build a JSON array.
        var purchase_Products = new Array();
        $("#tblProducts TBODY TR").each(function () {
            var row = $(this);
            var product = {};
            product.ItemName = row.find("TD").eq(0).html();
            product.Quantity = row.find("TD").eq(1).html();
            product.Price = row.find("TD").eq(2).html();
            product.Total = row.find("TD").eq(3).html();
            purchase_Products.push(product);
        });

        var form = $('#purchaseForm');
        var data = new FormData(form);
        data.append(purchase_Products);
        debugger;
        alert(data);

        //Send the JSON array to Controller using AJAX.
        $.ajax({
            type: "POST",
            url: "/Purchase/Create",
            data: data,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                alert(r + " record(s) inserted.");
            }
        });
    });
</script>